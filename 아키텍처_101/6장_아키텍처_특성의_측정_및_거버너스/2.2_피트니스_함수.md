## 2. 피트니스 함수

1. Building Evolutionary Architectures(2017)에서는
   진화적 컴퓨팅(evolutionary computing)의 유전자 알고리즘과 관련된 피트니스 함수 개념을 토대로 아키텍처 피트니스 함수(architecture fitness function)를 정의함!

   - 개발자가 유전자 알고리즘을 설계하여 유익한 결과를 얻으려면 결과의 품질을 객관적으로 측정하면서, 이 알고리즘을 통제할 수 있어야 함.
   - 피트니스 함수(fitness function)란 이처럼 결과가 목표에 얼마나 근접했는지를 나타내는 목표 함수
     - 외판원 문제 예시(복수의 정점과 간선의 가중치가 주어질 때, 최적의 이동경로를 찾는 문제): 유전자 알고리즘을 통해 푸는 경우, 거리가 가장 짧은 최적 경로를 표시하는 피트니스 함수, 이동 경로에 발생하는 전체 비용을 최소화하는 피트니스 함수, 외판원이 떠난 이후 전체 여향 시간을 줄이는 방법으로 최적화하는 피트니스 함수 등 전부 가능.

2. 피트니스 함수는 마치 체크리스트와 같음.

   - 프로들은 세부적인 일을 반복하다보면 간혹 빠뜨리고 지나치는 것들이 존재함. 이때 간결한 체크리스트를 사용하면 효과적으로 기억을 되살릴 수 있음.
     - 참고. 체크! 체크리스트(아툴 가완디, 2010): 전문직 종사자들의 체크리스트 활용법에 대한 책.
   - 피트니스 함수는 무거운 거버넌스 메커니즘보다는 아키텍트가 **중요한 아키텍처 원칙을 표현하고 자동으로 검증할 수 있는 메커니즘을 제공**함.

### 아키텍처 피트니스 함수

아키텍처 피트니스 함수란 **어떤 아키텍처 특성(또는 그런 특성들의 조합)의 객관적인 무결성을 평가하는 모든 메커니즘**(any mechanism)

- 피트니스 함수는 다운로드받아 실행하는 프레임워크가 아니라, **수많은 기존 도구들을 바라보는 새로운 시각**
- 피트니스 함수의 메커니즘은 사용하는 방법에 따라 메트릭, 모니터, 단위 테스트 라이브러리, 카오스 엔지니어링 등 기존의 많은 메커니즘과 중첩되는 부분 존재.
- 아키텍처 특성에 따라 피트니스 함수는 다양한 도구로 구현 가능.

> [TIP] 아키텍트는 개발자에게 피트니스 함수 사용을 권하기 전에 그들이 정확한 목적을 이해할 수 있도록 충분히 설명해야 합니다.

아래는 모듈성의 다양한 측면을 측정하는 피트니스 함수들의 예시

#### 모듈성 관련 피트니스 함수 - 순환 의존성

모듈성이 제대로 유지되지 못하면 코드베이스 구조에 해를 끼치므로 우선순위를 높게 두어 관리해야 함!

IDE에서 제공하는 자동 import 기능을 별 생각 없이 쓰다보면 컴포넌트들이 서로에 의존하는 순환 참조가 늘어남. 컴포넌트 간의 커플링이 증가하며 아키텍처는 점점 진흙잡탕 안티패턴에 빠지게 됨!

이는 피트니스 함수를 통해 순환 참조 여부를 발견함으로써 해결 가능!

- `JDepend`라는 메트릭 도구 활용 방법: JDepend를 통해 패키지 간 의존성을 체크하고 **순환 참조가 하나라도 존재하면 실패하는 테스트를 빌드 시점에 실행**하도록 함! => CI 시점에 자동으로 순환 의존성을 방지하는 것이 가능해짐!
- pp124-125의 실제 예시 코드 참고

#### 모듈성 관련 피트니스 함수 - 메인 시퀀스로부터의 거리 피트니스 함수

마찬가지로 JDepend로 수용 가능한 임계치를 설정하고, 클래스가 이 범위를 벗어나면 실패하는 테스트 작성 가능.

- p125의 실제 예시 코드 참고

#### 레이어드 아키텍처 관련 피트니스 함수 예시

그 외에도 피트니스 함수 도구는 갈수록 더 정교해졌으며, 목적에 따라 특화된 것들도 존재함.

`ArchUnit`를 통해 자바 진영에서 레이어 의존성을 확인하는 피트니스 함수 작성 가능 (p127 참고)

- JUnit의 체계 일부를 활용한 자바 테스트 프레임워크
- 모듈성에 특화된 테스트를 작성할 수 있도록 지원.
- 단위 테스트로 코드화한 사전 정의된 거버넌스 규칙을 풍성하게 제공.

`NetArchTest`를 통해 닷넷 진영(C#)에서도 레이어 의존성을 확인하는 피트니스 함수 작성 가능 (p127 참고)

##### 넷플릭스의 피트니스 함수 응용 사례

넷플릭스의 [카오스 멍키(Chaos Monkey)](https://netflix.github.io/chaosmonkey), [시미안 아미(Simian Army)](https://github.com/Netflix/SimianArmy)도 피트니스 함수의 응용 사례

아래는 피트니스 함수의 접근 방식을 잘 나타내는 예시들

- `적합성(Conformity) 멍키`를 통해 넷플릭스 아키텍트가 프로덕션에서 멍키로 강제한 거버넌스 규칙들 정의 가능.

  - "모든 서비스가 모든 REST verb에 유효한 응답을 해야 한다"고 결정했다면 적합성 멍키에 의해 해당 체크로직 구축 가능.

- `보안(Security) 멍키`는 열려 있으면 안되는 포트가 있거나, 각종 설정 오류 등 서비스에 잘 알려진 보안 취약점은 없는지 체크.

- `문지기(Janitor) 멍키`는 더 이상 다른 서비스에서 트래픽이 들어오지 않는 서비스 인스턴스가 존재하는지 체크. 고아 서비스(orphan service)를 찾아내면 프로덕션에서 제거.
  - 넷플릭스는 이처럼 진화적 아키텍처를 구축했기 때문에 개발자는 옛 서비스를 홀로 실행되도록 놔둔 상태로 언제든지 새 서비스로 이전 가능.

##### 시미안 아미의 기원

넷플릭스가 운영 인프라를 아마존 클라우드로 이전하기로 결정했을 때 회사 내 아키텍트들은 앞으로 운영 제어권을 잃게 될 것이란 점에 걱정이 많았음.

이처럼 운영 중 결함이 발생할 가능성에 대한 우려 때문에, 카오스 엔지니어링의 **카오스 멍키라는 프랙티스를 정착시켰고 이는 시미안 아미로 발전**함.

카오스 멍키: 일반적인 카오스를 프로덕션 환경에서 시뮬레이션하여 시스템이 얼마나 견딜 수 있는지 알아보는 것.

- 당시 일부 AWS 인스턴스에서 레이턴시 문제가 있었기 때문에 카오스 멍키를 통해 높은 레이턴시를 효과적으로 시뮬레이션할 수 있었음. => 향후 레이턴시 멍키라는 특화된 멍키도 만듬.

카오스 콩(Chaos Kong): 아마존 데이터 센터의 장애를 시뮬레이션하는 도구.

- 실제로 그러한 장애 문제 발생시, 서비스가 중단되는 사태를 예방하려는 목적.

카오스 엔지니어링의 핵심은 "무엇"이 잘못될 것인지가 아니라 "언제" 그렇게 잘못될 것인지가 문제라는 것. 이런 장애와 테스트를 미리 대비함으로써 시스템은 더욱 견고해질 수 있음.
