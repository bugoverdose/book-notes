# 3장 평가

## 심벌에 의미담기

인터프리터의 평가(evaluation) 프로세스는 번역(interpret)된 언어의 동작 방식을 정의함! 언어 명세(specification)을 구현하는 인터프리터가 코드/AST를 평가하는 방식이 해당 언어의 내부 동작 원리!

- `1 + 2`라는 표현식으로 AST 트리를 만든 이후, 이에 대한 평가 작업이 이루어져야 비로소 `3`이 됨!
- `5 > 1`라는 표현식이 `true`가 되는 것도 평가 작업이 있어야 가능!

## 평가 전략

소스코드를 평가할 때 선택할 수 있는 전략은 매우 다양함. 번역하려는 언어와 상관없이 평가 전략에 따라 인터프리터 구현체들은 다양하게 분기하게 됨.

cf) 사실 인터프리터와 컴파일러 사이의 경계선은 다소 흐릿함. 인터프리터는 실행 가능한 중간생성물(executable artifacts)을 남기지 않지만 고도로 최적화된 언어들에서는 판단하기도 애매함.

### 트리 순회 인터프리터(tree-walking interpreter)

- AST를 순회하고 각각의 노드를 방문하여 노드의 의미대로 즉시(on the fly) 처리하는 방식.
- 별도의 전처리 단계 및 컴파일 단계 없이 AST를 직접 번역(interpret)하는 가장 고전적이면서 분명한 AST 활용 방법.

- 성능상으로 가장 느리지만, 구현/확장에 용이함.
  - 안 쓰는 변수를 제거하도록 AST 구성, AST를 재귀 혹은 반복 평가에 더욱 적합한 *중간 표현물(Intermediate Representation; IR)으로 변경*하는 등 평가가 이루어지기 전에 최적화 수행 가능.

### 바이트 코드

AST를 순회하기는 하지만 AST를 있는 그대로 번역하는 대신 **바이트코드(bytecode)로 컴파일**하고, 바이트코드를 평가하기 위해 **가상머신**을 사용하는 인터프리터들도 존재함.

장점: 빠름. 기본적으로 성능상의 이점을 크게 높이는 전략.
단점: 구현하기 복잡함. JIT 기계어 컴파일러, ARM/x86 CPU에서 모두 동작하는 다중 머신 아키텍처 등 고려 필요.

- 바이트코드는 IR의 한 형태로, 각 바이트코드에는 AST를 나타내는 정보가 빽빽하게 포함됨!

- 기계어(네이티브 머신 코드, machine code)도 어셈블리어도 아니므로 인터프리터가 구동되고 있는 **운영체제나 CPU는 바이트코드를 직접적으로 실행할 수 없음**! 인터프리터의 일부인 **가상머신(virtual machine)이 번역**하는 대상.

  - 가상머신은 특정 바이트코드 형식을 이해하는 시스템을 모방하는 구조. VMWare나 VirtualBox가 실제 머신ㅇ과 CPU를 모방(emulate)하는 것과 유사.

- 호스트 언어 및 게스트 언어에 따라 바이트코드의 구체적 형식 및 어떠한 명령코드(opcode: 명령어 집합)로 구성되는지는 달라짐.

- 명령코드(opcode)는 일반적으로 어셈블리어 니모닉(mnemonics of assembly language)와 상당히 유사함.
  - 어셈블리어: 일반적으로 머신 코드 명령어와 1대1로 대응되는 저수준 언어. 머신코드 명령어에 의존하기 때문에 특정 아키텍처에 맞게 설계되는 언어.
  - 니모닉: 프로그래머가 명령코드를 쉽게 기억하고 대상화할 수 있도록 해주는 `push`, `pop`과 같은 이름들

### 다양한 평가 전략들

- 파서가 AST를 만드는 것이 아니라 바이트코드를 직접 배출(emit)하는 전략.
- JIT(Just In Time) 인터프리터/컴파일러: 소스코드로 AST를 구성하고 바이트코드로 변환한 이후, _바이트코드를 가상머신에서 실행하는 대신_ 실행 직전에 즉석에서 컴파일 작업 수행.
- 바이트코드로 컴파일하지 않고, AST 노드를 네이티브 머신 코드로 컴파일하고, **컴파일하는 즉시(Just In Time) 실행**.

### 인터프리터 구현체의 발전

- 같은 프로그래밍 언어더라도 기본적으로 성능 개선의 여지를 남겨두고 단순한 구현체에서 시작함.
- ex) Ruby: 1.8까지는 트리 순회 인터프리터, 1.9버전부터는 가상 머신 아키텍처가 되어 성능이 개선됨(소스코드=>AST=>바이트코드 컴파일=>가상머신에서 바이트코드 실행)
